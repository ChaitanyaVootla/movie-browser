# Movie Browser - AWS Infrastructure

This directory contains Terraform configuration for deploying the Movie Browser application infrastructure to AWS.

## Architecture

- **EC2 Instance**: t4g.medium (ARM64) in ap-south-2 with 60GB storage
- **MongoDB**: Version 8.x running in Docker container
- **VectorDB**: Python Flask application with ChromaDB
- **Lambda**: Movie ratings scraper (existing infrastructure)
- **Elastic IP**: Static public IP for DNS configuration
- **IAM Roles**: EC2 instance profile with Lambda invocation permissions

## Prerequisites

### 1. AWS CLI Configuration

```bash
aws configure
# Enter your AWS Access Key ID
# Enter your AWS Secret Access Key
# Default region: ap-south-2
# Default output format: json
```

### 2. Create S3 Backend (One-time setup)

```bash
# Create S3 bucket for Terraform state
aws s3api create-bucket \
  --bucket movie-browser-terraform-state \
  --region ap-south-2 \
  --create-bucket-configuration LocationConstraint=ap-south-2

# Enable versioning
aws s3api put-bucket-versioning \
  --bucket movie-browser-terraform-state \
  --versioning-configuration Status=Enabled

# Enable encryption
aws s3api put-bucket-encryption \
  --bucket movie-browser-terraform-state \
  --server-side-encryption-configuration '{
    "Rules": [{
      "ApplyServerSideEncryptionByDefault": {
        "SSEAlgorithm": "AES256"
      }
    }]
  }'

# Create DynamoDB table for state locking
aws dynamodb create-table \
  --table-name movie-browser-terraform-locks \
  --attribute-definitions AttributeName=LockID,AttributeType=S \
  --key-schema AttributeName=LockID,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST \
  --region ap-south-2
```

### 3. Configure Variables

```bash
# Copy example file
cp terraform.tfvars.example terraform.tfvars

# Edit terraform.tfvars with your values
# IMPORTANT: Set a strong MongoDB password!
```

## Deployment

### Initialize Terraform

```bash
cd terraform
terraform init
```

### Plan Infrastructure

```bash
terraform plan
```

### Deploy Infrastructure

```bash
terraform apply
```

Review the plan and type `yes` to confirm. This will:
- Create EC2 instance with Ubuntu 24.04 LTS
- Generate SSH key pair (saved as `movie-browser-ec2-key.pem`)
- Set up security groups
- Install Node.js 22, Python 3, Docker, PM2
- Deploy MongoDB 8.x in Docker
- Create Elastic IP
- Configure Lambda infrastructure

### Get Outputs

```bash
# View all outputs
terraform output

# Get SSH command
terraform output ssh_connection_string

# Get Elastic IP
terraform output elastic_ip

# Get MongoDB connection string
terraform output mongodb_connection_string
```

## Post-Deployment Setup

### 1. SSH into EC2

```bash
# Use the SSH key generated by Terraform
ssh -i movie-browser-ec2-key.pem ubuntu@<elastic-ip>

# Check setup completion
cat /var/log/user-data.log
cat /var/log/user-data-complete
```

### 2. Clone Repository

```bash
cd /home/ubuntu
git clone https://github.com/your-username/movie-browser.git
cd movie-browser
```

### 3. Configure Environment

Create `/home/ubuntu/movie-browser/.env`:

```bash
# TMDB API
TMDB_API_KEY=your_tmdb_api_key

# Google OAuth
GOOGLE_AUTH_CLIENT_ID=your_client_id
GOOGLE_AUTH_CLIENT_SECRET=your_client_secret

# AWS
AWS_ACCESS_KEY_ID=your_access_key
AWS_SECRET_ACCESS_KEY=your_secret_key
AWS_REGION=ap-south-2

# MongoDB
MONGO_PASS=your_mongodb_password
MONGO_IP=localhost
MONGO_PORT=27018

# Auth
AUTH_SECRET=your_random_auth_secret
AUTH_ORIGIN=https://themoviebrowser.com

# Application
NITRO_PORT=3001
CDN_API_URL=https://api.themoviebrowser.com

# OpenAI (for VectorDB)
OPENAI_API_KEY=your_openai_api_key
```

### 4. Install Dependencies

```bash
npm install --legacy-peer-deps
```

### 5. Build Application

```bash
npm run build
```

### 6. Setup VectorDB

```bash
cd VectorDB
python3 -m venv vector
source vector/bin/activate
pip install -r requirements.txt
deactivate
cd ..
```

### 7. Restore MongoDB Data

From your **local machine**, run:

```bash
./scripts/restore-to-ec2.sh \
  --ec2-host $(cd terraform && terraform output -raw elastic_ip) \
  --ssh-key terraform/movie-browser-ec2-key.pem \
  --s3-bucket movie-browser-migration-2025-10-19 \
  --mongodb-password 'your-mongodb-password'
```

### 8. Start PM2 Processes

Back on the EC2 instance:

```bash
pm2 start ecosystem.config.cjs
pm2 save
pm2 startup  # Follow the instructions shown
```

### 9. Verify Application

```bash
# Check PM2 status
pm2 status

# Check logs
pm2 logs

# Check MongoDB
docker ps | grep mongodb
docker exec mongodb mongosh -u root -p 'your-password' --authenticationDatabase admin

# Test application locally
curl http://localhost:3001
```

### 10. Configure DNS

Update your domain DNS records:

```
A record: themoviebrowser.com -> <elastic-ip>
A record: api.themoviebrowser.com -> <elastic-ip>
```

### 11. Setup SSL (Optional but Recommended)

Install and configure Caddy or Nginx with Let's Encrypt:

```bash
# Install Caddy
sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
sudo apt update
sudo apt install caddy

# Configure Caddyfile
sudo nano /etc/caddy/Caddyfile
```

Example Caddyfile:
```
themoviebrowser.com {
    reverse_proxy localhost:3001
}

api.themoviebrowser.com {
    reverse_proxy localhost:3001
}
```

```bash
# Restart Caddy
sudo systemctl restart caddy
```

## Lambda Deployment

The Lambda function for movie ratings scraping is managed alongside the EC2 infrastructure.

### Deploy Lambda Updates

From the `lambda/` directory:

```bash
cd lambda
npm install
npm run build
node package-lambda.js

# Apply Terraform changes
cd ../terraform
terraform apply
```

## Maintenance

### View Terraform State

```bash
terraform show
```

### Update Infrastructure

```bash
# Modify variables in terraform.tfvars or *.tf files
terraform plan
terraform apply
```

### Destroy Infrastructure

**WARNING**: This will delete all resources!

```bash
terraform destroy
```

### SSH Key Management

The SSH private key is stored locally at `movie-browser-ec2-key.pem` and is gitignored. Keep this file secure!

To regenerate:
```bash
terraform taint tls_private_key.ec2_key
terraform apply
```

### MongoDB Backups

Create regular backups to S3:

```bash
# On EC2 instance
docker exec mongodb mongodump \
  --uri="mongodb://root:your-password@localhost:27017/test?authSource=admin" \
  --gzip \
  --archive=/tmp/mongodb-backup.gz

# Upload to S3
aws s3 cp /tmp/mongodb-backup.gz s3://your-backup-bucket/backups/mongodb-$(date +%Y%m%d).gz

# Clean up
rm /tmp/mongodb-backup.gz
```

## Troubleshooting

### User Data Script Failed

Check the log:
```bash
ssh -i movie-browser-ec2-key.pem ubuntu@<elastic-ip>
sudo cat /var/log/user-data.log
```

### MongoDB Not Running

```bash
docker ps -a | grep mongodb
docker logs mongodb
docker start mongodb
```

### PM2 Processes Not Starting

```bash
pm2 logs
pm2 restart all
```

### Can't Connect to MongoDB Remotely

Check security group:
```bash
terraform output security_group_id
# Verify port 27018 is open in AWS Console
```

### SSH Connection Refused

1. Check EC2 instance state in AWS Console
2. Verify security group allows SSH (port 22)
3. Ensure SSH key permissions: `chmod 400 movie-browser-ec2-key.pem`

## Cost Estimation

- EC2 t4g.medium: ~$25/month (24/7 uptime)
- EBS 60GB gp3: ~$5/month
- Elastic IP: Free (while attached)
- Data Transfer: Variable
- Lambda: Pay-per-invocation
- S3: Minimal storage costs

**Total**: ~$30-40/month

## Security Notes

- MongoDB port 27018 is publicly accessible - ensure strong password
- SSH key is auto-generated - backup securely
- Consider using AWS Secrets Manager for sensitive data
- Enable CloudWatch monitoring for production
- Regular security updates: `sudo apt update && sudo apt upgrade`

## Files

- `main.tf` - EC2, networking, IAM, security groups
- `lambda.tf` - Lambda function configuration
- `backend.tf` - S3 backend for state management
- `variables.tf` - Input variables
- `outputs.tf` - Output values
- `user-data.sh` - EC2 initialization script
- `terraform.tfvars` - Variable values (gitignored)
- `terraform.tfvars.example` - Example configuration

## Support

For issues or questions:
1. Check logs: `/var/log/user-data.log` on EC2
2. Review Terraform output: `terraform show`
3. Check AWS Console for resource status

