name: Build and Deploy Nuxt Project

on:
  push:
    branches: [nuxt]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '18' # specify your Node.js version

    - name: Install dependencies
      run: npm install

    - name: Build
      run: npm run build

    - name: Archive build files
      run: tar -czvf build.tar.gz .nuxt

    - name: Copy build to remote
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.HOST }}
        username: root
        password: ${{ secrets.DIGITAL_OCEAN_PASS }}
        source: "build.tar.gz"
        target: "/beta/movie-browser"

    - name: Deploy on remote
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: root
        password: ${{ secrets.DIGITAL_OCEAN_PASS }}
        script: |
          cd /beta/movie-browser
          tar -xzvf build.tar.gz
          # Add any additional deployment commands here
          pm2 restart Nuxt

# name: Nuxt Test

# on:
#   push:
#     branches: [nuxt]

# jobs:
#   Deploy:
#       runs-on: ubuntu-latest
#       steps:
#           - uses: appleboy/ssh-action@master
#             with:
#               host: 64.227.132.75
#               username: root
#               password: ${{ secrets.DIGITAL_OCEAN_PASS }}
#               script: |
#                 bash -lc '
#                 source /root/.nvm/nvm.sh
#                 cd /beta/movie-browser
#                 git checkout -f nuxt
#                 git pull origin nuxt
#                 npm install
#                 npm run build
#                 pm2 delete all
#                 pm2 start "npm run preview" --name Nuxt
#                 '